<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Rock & Sync - Mobile</title>
    </head>
    <body>
        <div class="room-info">
            <h2>Rock & Sync</h2>
            <p>Room ID: <span id="roomId"></span></p>
            <div id="connectionStatus" class="status-badge status-disconnected">
                Connecting...
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none">
            Room is full! Please try another room.
        </div>

        <div id="playerInfo" style="display: none">
            <h3>You are Player <span id="playerNumber">-</span></h3>
        </div>

        <div id="controlArea" style="display: none">
            <h3>Waiting for game to start...</h3>
            <div id="controlButtons">
                <button
                    id="leftButton"
                    style="
                        width: 45%;
                        height: 150px;
                        margin: 10px;
                        font-size: 24px;
                    "
                    data-column="0"
                >
                    LEFT LANE
                </button>
                <button
                    id="rightButton"
                    style="
                        width: 45%;
                        height: 150px;
                        margin: 10px;
                        font-size: 24px;
                    "
                    data-column="1"
                >
                    RIGHT LANE
                </button>
            </div>
        </div>

        <script
            src="https://cdn.socket.io/4.8.1/socket.io.min.js"
            integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
            crossorigin="anonymous"
        ></script>
        <script>
            // Get room ID from URL
            const params = new URLSearchParams(window.location.search);
            const roomId = params.get('roomId');
            let playerId = -1; // Will be set by the server

            if (!roomId) {
                document.body.innerHTML =
                    '<div class="error-message">Error: No room ID provided</div>';
            } else {
                // Display room ID
                document.getElementById('roomId').textContent = roomId;

                // Connect to Socket.IO
                const socket = io({
                    path: '/real-time',
                });

                socket.on('connect', () => {
                    console.log('Connected to server');
                    const connectionStatus =
                        document.getElementById('connectionStatus');
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className =
                        'status-badge status-connected';

                    // Join the room as mobile client
                    socket.emit('join-room', {
                        roomId: roomId,
                        type: 'mobile',
                    });
                });

                socket.on('player-assigned', (data) => {
                    console.log('Assigned as player:', data.playerId);
                    playerId = data.playerId;

                    // Show player info and controls
                    document.getElementById('playerInfo').style.display =
                        'block';
                    document.getElementById('playerNumber').textContent =
                        playerId + 1;
                    document.getElementById('controlArea').style.display =
                        'block';

                    // Set button colors based on player
                    if (playerId === 0) {
                        document.getElementById(
                            'leftButton'
                        ).style.backgroundColor = '#FF0000';
                        document.getElementById(
                            'rightButton'
                        ).style.backgroundColor = '#FF0000';
                    } else {
                        document.getElementById(
                            'leftButton'
                        ).style.backgroundColor = '#0000FF';
                        document.getElementById(
                            'rightButton'
                        ).style.backgroundColor = '#0000FF';
                    }
                });

                socket.on('game-start', () => {
                    // Update UI to show game is starting
                    document.querySelector('#controlArea h3').textContent =
                        'Game Running - Hit the buttons!';
                });

                socket.on('room-full', () => {
                    console.log('Room is full');
                    document.getElementById('errorMessage').style.display =
                        'block';
                    document.getElementById('controlArea').style.display =
                        'none';
                });

                socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                    const connectionStatus =
                        document.getElementById('connectionStatus');
                    connectionStatus.textContent = 'Disconnected';
                    connectionStatus.className =
                        'status-badge status-disconnected';
                });

                // Set up button event handlers
                document.addEventListener('click', (e) => {
                    if (
                        e.target &&
                        e.target.matches('#controlButtons button')
                    ) {
                        const column = parseInt(e.target.dataset.column);

                        // Send button press to server
                        socket.emit('button-press', {
                            column: column,
                            playerId: playerId,
                        });

                        // Visual feedback
                        e.target.style.opacity = '0.7';
                        setTimeout(() => {
                            e.target.style.opacity = '1';
                        }, 100);
                    }
                });
            }
        </script>
    </body>
</html>
