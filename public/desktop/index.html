<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Rock & Sync</title>
    </head>
    <body>
        <h1>Rock & Sync</h1>

        <div class="room-info">
            <h2>Room ID: <span id="roomId"></span></h2>
            <div class="connection-status">
                Connected clients: <span id="connectedClients">0</span>/<span
                    id="maxClients"
                    >2</span
                >
                <div id="roomStatus" class="status-badge status-available">
                    Available
                </div>
            </div>
        </div>

        <div class="qr-container">
            <h3>Scan this QR code to join with your mobile</h3>
            <div id="qrcode"></div>
            <p class="mobile-url" id="mobileUrl"></p>
        </div>

        <div id="gameArea">
            <p>Waiting for mobile devices to connect...</p>
            <canvas
                id="gameCanvas"
                width="400"
                height="600"
                style="display: none"
            ></canvas>
            <div id="scoreDisplay" style="display: none">
                <div>Player 1: <span id="scoreP1">0</span></div>
                <div>Player 2: <span id="scoreP2">0</span></div>
            </div>
            <button id="startGameBtn" style="display: none">Start Game</button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <script
            src="https://cdn.socket.io/4.8.1/socket.io.min.js"
            integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
            crossorigin="anonymous"
        ></script>
        <script>
            // Game variables
            let gameRunning = false;
            let gameCanvas, gameCtx;
            let notes = [];
            let playerScores = [0, 0]; // Scores for player 1 and 2
            let lastFrame = 0;
            let noteSpeed = 3; // How fast notes fall
            const COLUMN_WIDTH = 200; // Width of each column
            let spawnInterval = 1500; // Time between note spawns (ms)
            let lastSpawnTime = 0;

            // Game initialization
            function initGame() {
                gameCanvas = document.getElementById('gameCanvas');
                gameCtx = gameCanvas.getContext('2d');

                // Set up game loop
                requestAnimationFrame(gameLoop);
            }

            // Game loop
            function gameLoop(timestamp) {
                if (!lastFrame) lastFrame = timestamp;
                const deltaTime = timestamp - lastFrame;
                lastFrame = timestamp;

                if (gameRunning) {
                    // Clear canvas
                    gameCtx.clearRect(
                        0,
                        0,
                        gameCanvas.width,
                        gameCanvas.height
                    );

                    // Draw game board
                    drawBoard();

                    // Spawn new notes
                    if (timestamp - lastSpawnTime > spawnInterval) {
                        spawnNote();
                        lastSpawnTime = timestamp;
                    }

                    // Update and draw notes
                    updateNotes(deltaTime);

                    // Check for missed notes
                    checkMissedNotes();
                }

                requestAnimationFrame(gameLoop);
            }

            // Draw game board
            function drawBoard() {
                // Draw column divider
                gameCtx.fillStyle = '#333';
                gameCtx.fillRect(COLUMN_WIDTH - 1, 0, 2, gameCanvas.height);

                // Draw target zone
                gameCtx.fillStyle = 'rgba(0, 255, 0, 0.3)';
                gameCtx.fillRect(
                    0,
                    gameCanvas.height - 50,
                    gameCanvas.width,
                    10
                );
            }

            // Spawn a new note
            function spawnNote() {
                const column = Math.floor(Math.random() * 2); // 0 or 1

                notes.push({
                    x: column * COLUMN_WIDTH,
                    y: 0,
                    width: COLUMN_WIDTH,
                    height: 30,
                    column: column,
                    hit: false,
                    missed: false,
                });
            }

            // Update all notes
            function updateNotes(deltaTime) {
                for (let note of notes) {
                    if (!note.hit && !note.missed) {
                        // Move note down
                        note.y += noteSpeed * (deltaTime / 16);

                        // Draw note
                        gameCtx.fillStyle =
                            note.column === 0 ? '#FF0000' : '#0000FF';
                        gameCtx.fillRect(
                            note.x,
                            note.y,
                            note.width,
                            note.height
                        );
                    }
                }
            }

            // Check for notes that have passed the target zone
            function checkMissedNotes() {
                for (let note of notes) {
                    if (
                        !note.hit &&
                        !note.missed &&
                        note.y > gameCanvas.height
                    ) {
                        note.missed = true;
                    }
                }

                // Remove notes that are off screen
                notes = notes.filter(
                    (note) => !(note.missed && note.y > gameCanvas.height + 50)
                );
            }

            // Handle player button press
            function handlePlayerPress(playerId, column) {
                if (!gameRunning) return;

                // Convert from 0-based to 1-based for logging
                const playerNum = playerId + 1;
                console.log(`Player ${playerNum} pressed column ${column}`);

                // Check for hits
                for (let note of notes) {
                    if (note.column === column && !note.hit && !note.missed) {
                        // Check if note is in hit zone
                        if (
                            note.y >= gameCanvas.height - 70 &&
                            note.y <= gameCanvas.height - 30
                        ) {
                            note.hit = true;

                            // Add score for the correct player
                            playerScores[playerId]++;
                            document.getElementById(
                                `scoreP${playerNum}`
                            ).textContent = playerScores[playerId];

                            break;
                        }
                    }
                }
            }

            // Start game
            function startGame() {
                gameRunning = true;
                playerScores = [0, 0];
                notes = [];
                lastSpawnTime = performance.now();

                // Update UI
                document.getElementById('scoreP1').textContent = '0';
                document.getElementById('scoreP2').textContent = '0';

                // Notify mobile clients that game is starting
                socket.emit('game-start');
            }

            function createQRCode() {
                // Display room ID
                document.getElementById('roomId').textContent = roomId;

                // Create QR code
                const serverUrl = window.location.origin;
                const mobileUrl = `${serverUrl}/mobile?roomId=${roomId}`;

                // Generate QR code
                const qrcode = new QRCode(document.getElementById('qrcode'), {
                    text: mobileUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H,
                });

                // Display mobile URL
                document.getElementById('mobileUrl').textContent = mobileUrl;
            }

            // Get room ID from URL
            const params = new URLSearchParams(window.location.search);
            const roomId = params.get('roomId');

            if (!roomId) {
                console.error('No room ID found in URL');
                document.body.innerHTML = '<h1>Error: No room ID found</h1>';
            } else {
                createQRCode();

                // Connect to Socket.IO
                const socket = io({
                    path: '/real-time',
                });

                socket.on('connect', () => {
                    console.log('Connected to server');
                    // Join the room as desktop client
                    socket.emit('join-room', {
                        roomId: roomId,
                        type: 'desktop',
                    });
                });

                // Listen for room status updates
                socket.on('room-status', (data) => {
                    console.log('Room status update:', data);
                    document.getElementById('connectedClients').textContent =
                        data.connectedClients;
                    document.getElementById('maxClients').textContent =
                        data.maxClients;

                    const roomStatusEl = document.getElementById('roomStatus');

                    if (data.connectedClients >= data.maxClients) {
                        roomStatusEl.textContent = 'Full';
                        roomStatusEl.className = 'status-badge status-full';
                    } else {
                        roomStatusEl.textContent = 'Available';
                        roomStatusEl.className =
                            'status-badge status-available';
                    }

                    // Update game area
                    const gameArea = document.getElementById('gameArea');

                    if (data.connectedClients === 0) {
                        document.getElementById('gameCanvas').style.display =
                            'none';
                        document.getElementById('scoreDisplay').style.display =
                            'none';
                        document.getElementById('startGameBtn').style.display =
                            'none';
                        gameArea.innerHTML =
                            '<p>Waiting for mobile devices to connect...</p>' +
                            '<canvas id="gameCanvas" width="400" height="600" style="display: none;"></canvas>' +
                            '<div id="scoreDisplay" style="display: none;">' +
                            '<div>Player 1: <span id="scoreP1">0</span></div>' +
                            '<div>Player 2: <span id="scoreP2">0</span></div>' +
                            '</div>' +
                            '<button id="startGameBtn" style="display: none;">Start Game</button>';
                    } else if (data.connectedClients < data.maxClients) {
                        document.getElementById('gameCanvas').style.display =
                            'none';
                        document.getElementById('scoreDisplay').style.display =
                            'none';
                        document.getElementById('startGameBtn').style.display =
                            'none';
                        document.querySelector('#gameArea p').textContent =
                            'Waiting for more players... ' +
                            data.connectedClients +
                            ' of ' +
                            data.maxClients +
                            ' connected.';
                    } else {
                        // All players connected - show the game
                        document.querySelector('#gameArea p').textContent =
                            'All players connected! Game ready to start.';
                        document.getElementById('gameCanvas').style.display =
                            'block';
                        document.getElementById('scoreDisplay').style.display =
                            'block';
                        document.getElementById('startGameBtn').style.display =
                            'block';

                        // Initialize game if not already done
                        if (!gameCtx) {
                            initGame();
                        }
                    }
                });

                // Listen for player button presses
                socket.on('player-press', (data) => {
                    handlePlayerPress(data.playerId, data.column);
                });

                socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                });

                // Add event listener for start button
                document.addEventListener('click', (e) => {
                    if (e.target && e.target.id === 'startGameBtn') {
                        startGame();
                    }
                });
            }
        </script>
    </body>
</html>
